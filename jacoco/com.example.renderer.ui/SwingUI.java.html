<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SwingUI.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GraphRenderSystem</a> &gt; <a href="index.source.html" class="el_package">com.example.renderer.ui</a> &gt; <span class="el_source">SwingUI.java</span></div><h1>SwingUI.java</h1><pre class="source lang-java linenums">package com.example.renderer.ui;

/**
 * SwingUI是图形渲染系统的主界面，使用Swing实现。
 * 
 * &lt;p&gt;主要功能组件：
 * &lt;ul&gt;
 *   &lt;li&gt;绘图面板(DrawingPanel) - 显示图形&lt;/li&gt;
 *   &lt;li&gt;控制按钮 - 添加圆形、矩形、椭圆和三角形&lt;/li&gt;
 *   &lt;li&gt;撤销/重做功能 - 通过UndoManager实现命令历史管理&lt;/li&gt;
 *   &lt;li&gt;文件操作 - 通过PersistenceManager实现图形的保存和加载&lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * &lt;p&gt;设计模式应用：
 * &lt;ul&gt;
 *   &lt;li&gt;命令模式 - 通过Command接口实现操作封装&lt;/li&gt;
 *   &lt;li&gt;桥接模式 - 通过Renderer接口分离渲染逻辑&lt;/li&gt;
 *   &lt;li&gt;单例模式 - 使用PersistenceManager管理持久化&lt;/li&gt;
 *   &lt;li&gt;观察者模式 - 图形变化时自动重绘&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * &lt;p&gt;典型使用场景：
 * &lt;pre&gt;{@code
 * SwingUI ui = new SwingUI(); // 创建并显示界面
 * }&lt;/pre&gt;
 * 
 * @see DrawingPanel 绘图面板实现
 * @see UndoManager 撤销/重做管理
 * @see PersistenceManager 持久化管理器
 * @author liying
 * @since 1.0
 * @version 1.0.0
 */

import com.example.renderer.bridge.Renderer;
import com.example.renderer.bridge.RendererFactory;
import com.example.renderer.config.GlobalConfig;
import com.example.renderer.exception.RendererCreationException;
import com.example.renderer.factory.*;
import com.example.renderer.command.*;
import com.example.renderer.singleton.PersistenceManager;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import javax.swing.*;
import java.awt.*;
import java.io.File;
import java.util.ArrayList;
import java.util.List;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import java.awt.*;
import java.util.ArrayList;
import java.util.List;

import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;

import com.example.renderer.factory.Circle;
import com.example.renderer.factory.Rectangle;
import com.example.renderer.factory.Ellipse;
import com.example.renderer.factory.Triangle;
import com.example.renderer.bridge.Renderer;
import com.example.renderer.bridge.SwingRenderer;
import com.example.renderer.command.AddShapeCommand;
import com.example.renderer.command.UndoManager;


//import com.example.renderer.persistence.PersistenceManager;
import com.example.renderer.singleton.PersistenceManager;



/**
 * SwingUI是图形渲染系统的主界面，使用Swing实现。
 * 
 * &lt;p&gt;主要功能组件：
 * &lt;ul&gt;
 *   &lt;li&gt;绘图面板(DrawingPanel) - 显示图形&lt;/li&gt;
 *   &lt;li&gt;控制按钮 - 添加圆形、矩形、椭圆和三角形&lt;/li&gt;
 *   &lt;li&gt;撤销/重做功能 - 通过UndoManager实现命令历史管理&lt;/li&gt;
 *   &lt;li&gt;文件操作 - 通过PersistenceManager实现图形的保存和加载&lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * @see DrawingPanel 绘图面板实现
 * @see UndoManager 撤销/重做管理
 * @see PersistenceManager 持久化管理器
 * @author liying
 * @since 1.0
 */
public class SwingUI extends JFrame {
<span class="fc" id="L93">    private static final Logger LOGGER = LoggerFactory.getLogger(SwingUI.class);</span>
    /** 图形列表 */
<span class="fc" id="L95">    final List&lt;com.example.renderer.factory.Shape&gt; shapes = new ArrayList&lt;&gt;();</span>
    
    /** 渲染器实现 */
    Renderer renderer;
    
    /** 撤销管理器 */
<span class="fc" id="L101">    private UndoManager undoManager = new UndoManager();</span>
    
    /** 绘图面板组件 */
    private DrawingPanel drawingPanel;


    /**
     * 创建并初始化Swing图形用户界面。
     * 
     * &lt;p&gt;初始化内容包括：
     * &lt;ul&gt;
     *   &lt;li&gt;设置窗口标题和大小&lt;/li&gt;
     *   &lt;li&gt;创建绘图面板&lt;/li&gt;
     *   &lt;li&gt;添加各种图形按钮&lt;/li&gt;
     *   &lt;li&gt;设置按钮事件监听器&lt;/li&gt;
     *   &lt;li&gt;添加撤销/重做功能&lt;/li&gt;
     *   &lt;li&gt;添加文件保存/加载功能&lt;/li&gt;
     * &lt;/ul&gt;
     */
<span class="fc" id="L120">    public SwingUI() {</span>
<span class="fc" id="L121">        setTitle(&quot;图形渲染系统 - Swing 可视化&quot;);</span>
<span class="fc" id="L122">        setSize(800, 600);</span>
<span class="fc" id="L123">        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span>
<span class="fc" id="L124">        setLocationRelativeTo(null);</span>


        // 通过配置获取渲染器
<span class="fc" id="L128">        String mode = GlobalConfig.getInstance().getRenderMode();</span>
        try {
<span class="fc" id="L130">            renderer = RendererFactory.create(mode);</span>
<span class="nc" id="L131">        } catch (RendererCreationException e) {</span>
<span class="nc" id="L132">            LOGGER.error(&quot;Renderer initialization failed&quot;, e);</span>
<span class="nc" id="L133">            JOptionPane.showMessageDialog(this,</span>
<span class="nc" id="L134">                String.format(&quot;无法初始化渲染器 %s: %s\n将使用默认Swing渲染器&quot;,</span>
<span class="nc" id="L135">                    mode, e.getMessage()),</span>
                &quot;渲染器错误&quot;, JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L137">            renderer = createFallbackRenderer();</span>
<span class="fc" id="L138">        }</span>

<span class="fc" id="L140">        drawingPanel = new DrawingPanel(shapes, renderer);</span>
<span class="fc" id="L141">        add(drawingPanel, BorderLayout.CENTER);  // 添加绘图面板到中心区域</span>

<span class="fc" id="L143">        JButton btnCircle = new JButton(&quot;添加圆形&quot;);</span>
<span class="fc" id="L144">        btnCircle.setName(&quot;btnCircle&quot;);</span>
<span class="fc" id="L145">        JButton btnRect = new JButton(&quot;添加矩形&quot;);</span>
<span class="fc" id="L146">        btnRect.setName(&quot;btnRect&quot;);</span>
<span class="fc" id="L147">        JButton btnEllipse = new JButton(&quot;添加椭圆&quot;);</span>
<span class="fc" id="L148">        btnEllipse.setName(&quot;btnEllipse&quot;);</span>
<span class="fc" id="L149">        JButton btnTriangle = new JButton(&quot;添加三角形&quot;);</span>
<span class="fc" id="L150">        btnTriangle.setName(&quot;btnTriangle&quot;);</span>
<span class="fc" id="L151">        JButton btnUndo = new JButton(&quot;撤销&quot;);</span>
<span class="fc" id="L152">        btnUndo.setName(&quot;btnUndo&quot;);</span>
<span class="fc" id="L153">        JButton btnRedo = new JButton(&quot;重做&quot;);</span>
<span class="fc" id="L154">        btnRedo.setName(&quot;btnRedo&quot;);</span>

<span class="fc" id="L156">        JPanel panel = new JPanel();</span>
<span class="fc" id="L157">        panel.add(btnCircle);</span>
<span class="fc" id="L158">        panel.add(btnRect);</span>
<span class="fc" id="L159">        panel.add(btnEllipse);</span>
<span class="fc" id="L160">        panel.add(btnTriangle);</span>
<span class="fc" id="L161">        panel.add(btnUndo);</span>
<span class="fc" id="L162">        panel.add(btnRedo);</span>

        // 添加圆形按钮事件处理
<span class="fc" id="L165">        btnCircle.addActionListener(e -&gt; {</span>
            // 创建圆形实例，位置和半径根据已有图形数量动态调整
<span class="fc" id="L167">            Circle c = new Circle(100 + shapes.size() * 10, 100, 30 + shapes.size() * 5);</span>
<span class="fc" id="L168">            AddShapeCommand cmd = new AddShapeCommand(shapes, c);</span>
<span class="fc" id="L169">            undoManager.executeCommand(cmd);</span>
<span class="fc" id="L170">            repaint();</span>
<span class="fc" id="L171">        });</span>

<span class="fc" id="L173">        btnRect.addActionListener(e -&gt; {</span>
<span class="nc" id="L174">            Rectangle r = new Rectangle(200, 150 + shapes.size() * 10, 60, 40);</span>
<span class="nc" id="L175">            AddShapeCommand cmd = new AddShapeCommand(shapes, r);</span>
<span class="nc" id="L176">            undoManager.executeCommand(cmd);</span>
<span class="nc" id="L177">            repaint();</span>
<span class="nc" id="L178">        });</span>

<span class="fc" id="L180">        btnEllipse.addActionListener(e -&gt; {</span>
<span class="nc" id="L181">            Ellipse e1 = new Ellipse(300, 200, 50, 30);</span>
<span class="nc" id="L182">            AddShapeCommand cmd = new AddShapeCommand(shapes, e1);</span>
<span class="nc" id="L183">            undoManager.executeCommand(cmd);</span>
<span class="nc" id="L184">            repaint();</span>
<span class="nc" id="L185">        });</span>

<span class="fc" id="L187">        btnTriangle.addActionListener(e -&gt; {</span>
<span class="nc" id="L188">            Triangle t = new Triangle(400, 300, 450, 350, 420, 390);</span>
<span class="nc" id="L189">            AddShapeCommand cmd = new AddShapeCommand(shapes, t);</span>
<span class="nc" id="L190">            undoManager.executeCommand(cmd);</span>
<span class="nc" id="L191">            repaint();</span>
<span class="nc" id="L192">        });</span>

<span class="fc" id="L194">        btnUndo.addActionListener(e -&gt; {</span>
<span class="nc" id="L195">            undoManager.undo();</span>
<span class="nc" id="L196">            repaint();</span>
<span class="nc" id="L197">        });</span>

<span class="fc" id="L199">        btnRedo.addActionListener(e -&gt; {</span>
<span class="nc" id="L200">            undoManager.redo();</span>
<span class="nc" id="L201">            repaint();</span>
<span class="nc" id="L202">        });</span>

<span class="fc" id="L204">        JButton btnSave = new JButton(&quot;保存图形&quot;);</span>
<span class="fc" id="L205">        btnSave.setName(&quot;btnSave&quot;);</span>
<span class="fc" id="L206">        btnSave.addActionListener(e -&gt; saveShapes());</span>

<span class="fc" id="L208">        JButton btnLoad = new JButton(&quot;载入图形&quot;);</span>
<span class="fc" id="L209">        btnLoad.setName(&quot;btnLoad&quot;);</span>
<span class="fc" id="L210">        btnLoad.addActionListener(e -&gt; loadShapes());</span>

<span class="fc" id="L212">        panel.add(btnSave);</span>
<span class="fc" id="L213">        panel.add(btnLoad);</span>

<span class="fc" id="L215">        add(panel, BorderLayout.SOUTH);</span>

<span class="fc" id="L217">        pack();  // 让窗口根据内容尺寸调整</span>
<span class="fc" id="L218">        setLocationRelativeTo(null);  // 窗口居中</span>
<span class="fc" id="L219">        setVisible(true);</span>


<span class="fc" id="L222">    }</span>

    // 移除paint()方法重写，完全使用DrawingPanel进行绘制


    /**
     * 保存当前图形列表到文件。
     * 使用JFileChooser让用户选择保存位置，然后通过PersistenceManager
     * 将图形列表序列化为JSON格式保存。
     * 
     * &lt;p&gt;处理流程：
     * 1. 显示文件选择对话框
     * 2. 用户选择保存位置
     * 3. 调用PersistenceManager保存数据
     * 4. 显示操作结果提示
     * 
     * @see PersistenceManager#saveShapesToFile(List, String)
     */
    private void saveShapes() {
<span class="fc" id="L241">        File file = selectSaveFile();</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">        if (file != null) {</span>
            try {
<span class="fc" id="L244">                PersistenceManager.getInstance().saveShapesToFile(shapes, file.getAbsolutePath());</span>
<span class="fc" id="L245">                showMessage(&quot;保存成功&quot;);</span>
<span class="nc" id="L246">            } catch (Exception ex) {</span>
<span class="nc" id="L247">                showMessage(&quot;保存失败: &quot; + ex.getMessage());</span>
<span class="fc" id="L248">            }</span>
        }
<span class="fc" id="L250">    }</span>


    /**
     * 从文件加载图形列表。
     * 使用JFileChooser让用户选择要加载的文件，然后通过PersistenceManager
     * 从JSON格式反序列化为图形对象列表。
     * 
     * &lt;p&gt;处理流程：
     * 1. 显示文件选择对话框
     * 2. 用户选择要加载的文件
     * 3. 调用PersistenceManager加载数据
     * 4. 清空当前图形列表并添加加载的图形
     * 5. 刷新绘图面板显示新图形
     * 6. 显示操作结果提示
     * 
     * @see PersistenceManager#loadShapesFromFile(String) 
     */
    /**
     * 创建回退渲染器（包级访问权限，供单元测试使用）
     * @return 渲染器实例
     */
    Renderer createFallbackRenderer() {
        try {
<span class="fc" id="L274">            return new SwingRenderer();</span>
<span class="nc" id="L275">        } catch (Exception e) {</span>
<span class="nc" id="L276">            LOGGER.error(&quot;Fallback renderer creation failed&quot;, e);</span>
<span class="nc" id="L277">            throw new IllegalStateException(&quot;无法创建回退渲染器&quot;, e);</span>
        }
    }


    protected void loadShapes() {
<span class="fc" id="L283">        File file = selectOpenFile();</span>
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">        if (file != null) {</span>
            try {
<span class="fc" id="L286">                List&lt;com.example.renderer.factory.Shape&gt; loadedShapes = PersistenceManager.getInstance().loadShapesFromFile(file.getAbsolutePath());</span>
<span class="fc" id="L287">                shapes.clear();</span>
<span class="fc" id="L288">                shapes.addAll(loadedShapes);</span>
<span class="fc" id="L289">                drawingPanel.repaint();</span>
<span class="fc" id="L290">                showMessage(&quot;载入成功&quot;);</span>
<span class="nc" id="L291">            } catch (Exception ex) {</span>
<span class="nc" id="L292">                showMessage(&quot;载入失败: &quot; + ex.getMessage());</span>
<span class="fc" id="L293">            }</span>
        }
<span class="fc" id="L295">    }</span>

    protected File selectSaveFile() {
<span class="nc" id="L298">        JFileChooser chooser = new JFileChooser();</span>
<span class="nc" id="L299">        int ret = chooser.showSaveDialog(this);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">        return (ret == JFileChooser.APPROVE_OPTION) ? chooser.getSelectedFile() : null;</span>
    }

    protected File selectOpenFile() {
<span class="nc" id="L304">        JFileChooser chooser = new JFileChooser();</span>
<span class="nc" id="L305">        int ret = chooser.showOpenDialog(this);</span>
<span class="nc bnc" id="L306" title="All 2 branches missed.">        return (ret == JFileChooser.APPROVE_OPTION) ? chooser.getSelectedFile() : null;</span>
    }

    protected void showMessage(String message) {
<span class="fc" id="L310">        JOptionPane.showMessageDialog(this, message);</span>
<span class="fc" id="L311">    }</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>